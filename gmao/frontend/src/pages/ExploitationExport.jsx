import React, { useState, useEffect } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  CircularProgress,
  Alert
} from '@mui/material';
import { Download as DownloadIcon } from '@mui/icons-material';
import { useTranslation } from 'react-i18next';
import api from '../services/api';

export default function ExploitationExport() {
  const { t } = useTranslation();
  const [templates, setTemplates] = useState([]);
  const [loading, setLoading] = useState(true);
  const [downloading, setDownloading] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    let cancelled = false;
    api.get('/exploitation/templates')
      .then((res) => { if (!cancelled) setTemplates(res.data || []); })
      .catch((err) => { if (!cancelled) setError(err.response?.data?.error || err.message); })
      .finally(() => { if (!cancelled) setLoading(false); });
    return () => { cancelled = true; };
  }, []);

  const handleDownload = async (entityId) => {
    setDownloading(entityId);
    setError(null);
    try {
      const res = await api.get(`/exploitation/export/${entityId}`, { responseType: 'blob' });
      const url = window.URL.createObjectURL(res.data);
      const a = document.createElement('a');
      a.href = url;
      a.download = `template-${entityId}.xlsx`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      setError(err.response?.data?.error || err.message || 'Erreur téléchargement');
    } finally {
      setDownloading(null);
    }
  };

  if (loading) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight={200}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box>
      <Typography variant="h5" fontWeight={700} sx={{ mb: 3 }}>
        {t('item.exploitation_export')}
      </Typography>
      <Typography color="text.secondary" sx={{ mb: 2 }}>
        {t('exploitation.exportHint')}
      </Typography>
      {error && (
        <Alert severity="error" onClose={() => setError(null)} sx={{ mb: 2 }}>
          {error}
        </Alert>
      )}
      <Card sx={{ borderRadius: 2 }}>
        <CardContent>
          <List>
            {templates.map((item) => (
              <ListItem
                key={item.id}
                sx={{
                  border: '1px solid',
                  borderColor: 'divider',
                  borderRadius: 2,
                  mb: 1
                }}
              >
                <ListItemText primary={item.label} secondary={item.sheetName} />
                <ListItemSecondaryAction>
                  <Button
                    variant="outlined"
                    startIcon={downloading === item.id ? <CircularProgress size={16} /> : <DownloadIcon />}
                    onClick={() => handleDownload(item.id)}
                    disabled={!!downloading}
                  >
                    {downloading === item.id ? t('common.saving') : t('common.download', 'Télécharger')}
                  </Button>
                </ListItemSecondaryAction>
              </ListItem>
            ))}
          </List>
          {templates.length === 0 && !error && (
            <Typography color="text.secondary">{t('exploitation.noTemplates')}</Typography>
          )}
        </CardContent>
      </Card>
    </Box>
  );
}
